{
  "openapi": "3.1.0",
  "info": {
    "title": "LogLife Plugin API",
    "version": "0.1.0",
    "description": "HTTP API exposed by the LogLife plugin running inside the OpenClaw gateway. All endpoints require Bearer token authentication."
  },
  "servers": [
    {
      "url": "http://localhost:18789",
      "description": "Local development"
    }
  ],
  "security": [
    {
      "bearerAuth": []
    }
  ],
  "components": {
    "securitySchemes": {
      "bearerAuth": {
        "type": "http",
        "scheme": "bearer",
        "description": "The API key configured in openclaw.json under plugins.entries.loglife.config.apiKey"
      }
    },
    "schemas": {
      "Session": {
        "type": "object",
        "properties": {
          "sessionKey": { "type": "string" },
          "sessionId": { "type": "string" },
          "updatedAt": { "type": "number", "description": "Unix timestamp (ms)" },
          "abortedLastRun": { "type": "boolean" },
          "chatType": { "type": "string" },
          "lastChannel": { "type": "string" },
          "origin": {
            "type": "object",
            "properties": {
              "label": { "type": "string" },
              "from": { "type": "string" },
              "to": { "type": "string" }
            }
          },
          "deliveryContext": {
            "type": "object",
            "properties": {
              "channel": { "type": "string" },
              "to": { "type": "string" }
            }
          },
          "compactionCount": { "type": "integer" },
          "inputTokens": { "type": "integer" },
          "outputTokens": { "type": "integer" },
          "totalTokens": { "type": "integer" },
          "model": { "type": "string" }
        }
      },
      "Error": {
        "type": "object",
        "properties": {
          "error": { "type": "string" }
        },
        "required": ["error"]
      }
    }
  },
  "paths": {
    "/loglife/sessions": {
      "get": {
        "operationId": "getSessions",
        "summary": "Get session data",
        "description": "Look up a single session by phone number, session ID, or session key. At least one query parameter is required.",
        "parameters": [
          {
            "name": "phone",
            "in": "query",
            "schema": { "type": "string" },
            "description": "Phone number (e.g. +15551234567). Matches against origin.from in sessions.json.",
            "example": "+15551234567"
          },
          {
            "name": "sessionId",
            "in": "query",
            "schema": { "type": "string" },
            "description": "Session UUID"
          },
          {
            "name": "key",
            "in": "query",
            "schema": { "type": "string" },
            "description": "Session key (the top-level key in sessions.json)"
          }
        ],
        "responses": {
          "200": {
            "description": "Session found",
            "content": {
              "application/json": {
                "schema": { "$ref": "#/components/schemas/Session" }
              }
            }
          },
          "400": {
            "description": "Missing query parameter",
            "content": {
              "application/json": {
                "schema": { "$ref": "#/components/schemas/Error" }
              }
            }
          },
          "401": {
            "description": "Unauthorized — missing or invalid API key"
          },
          "404": {
            "description": "Session not found",
            "content": {
              "application/json": {
                "schema": { "$ref": "#/components/schemas/Error" }
              }
            }
          }
        }
      }
    },
    "/loglife/verify/send": {
      "post": {
        "operationId": "verifySend",
        "summary": "Send verification code",
        "description": "Generates a 6-digit verification code and sends it to the specified phone number via WhatsApp. Rate limited to one code per phone number per 60 seconds. Codes expire after 5 minutes.",
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": {
                "type": "object",
                "required": ["phone"],
                "properties": {
                  "phone": {
                    "type": "string",
                    "description": "Phone number to send the code to",
                    "example": "+15551234567"
                  }
                }
              }
            }
          }
        },
        "responses": {
          "200": {
            "description": "Code sent successfully",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "sent": { "type": "boolean", "example": true }
                  }
                }
              }
            }
          },
          "400": {
            "description": "Missing or invalid phone number"
          },
          "401": {
            "description": "Unauthorized"
          },
          "429": {
            "description": "Rate limited — code already sent within 60 seconds"
          },
          "502": {
            "description": "Failed to send message via gateway"
          }
        }
      }
    },
    "/loglife/verify/check": {
      "post": {
        "operationId": "verifyCheck",
        "summary": "Validate verification code",
        "description": "Checks whether the provided code matches the one sent to the given phone number. Uses timing-safe comparison. Codes are single-use — deleted after successful verification.",
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": {
                "type": "object",
                "required": ["phone", "code"],
                "properties": {
                  "phone": {
                    "type": "string",
                    "example": "+15551234567"
                  },
                  "code": {
                    "type": "string",
                    "description": "6-digit verification code",
                    "example": "482910"
                  }
                }
              }
            }
          }
        },
        "responses": {
          "200": {
            "description": "Verification result",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "verified": { "type": "boolean" },
                    "error": { "type": "string", "description": "Present when verified is false" }
                  }
                }
              }
            }
          },
          "400": {
            "description": "Missing required fields"
          },
          "401": {
            "description": "Unauthorized"
          }
        }
      }
    },
    "/loglife/register": {
      "post": {
        "operationId": "registerUser",
        "summary": "Register a new user",
        "description": "Adds a new user to the multi-user configuration. Creates an OpenClaw agent, binding, and allow-list entry for the given phone number, then triggers a gateway hot-reload so the user can start messaging immediately. Idempotent — if the phone is already registered, returns success without duplicating.",
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": {
                "type": "object",
                "required": ["phone"],
                "properties": {
                  "phone": {
                    "type": "string",
                    "description": "Phone number in E.164 format",
                    "example": "+15551234567"
                  },
                  "name": {
                    "type": "string",
                    "description": "Display name (used to derive the user/agent ID)",
                    "example": "Alice Smith"
                  },
                  "model": {
                    "type": "string",
                    "description": "LLM model override for this user (defaults to the global default)",
                    "example": "anthropic/claude-sonnet-4-5"
                  }
                }
              }
            }
          }
        },
        "responses": {
          "200": {
            "description": "User registered (or already exists)",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "registered": { "type": "boolean", "example": true },
                    "userId": { "type": "string", "description": "The generated user/agent ID", "example": "alice-smith" },
                    "existing": { "type": "boolean", "description": "True if the phone was already registered" }
                  }
                }
              }
            }
          },
          "400": {
            "description": "Missing or invalid phone number"
          },
          "401": {
            "description": "Unauthorized"
          },
          "500": {
            "description": "Registration failed (config write or generation error)"
          }
        }
      }
    }
  }
}
