<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LogLife Emulator</title>
    <link rel="icon" type="image/png" href="{{ url_for('static', filename='favicon.png') }}">
    <style>
        :root {
            /* Dark Theme Colors */
            --bg: #0d1117;
            --card: #161b22;
            --text: #e6edf3;
            --muted: #8b9eb1;
            --border: #30363d;

            --primary: #3b82f6;
            --primary-600: #2563eb;

            --accent: linear-gradient(135deg, #3b82f6, #2563eb 60%, #1d4ed8 90%);
            --ring: rgba(37, 99, 235, 0.25);
            --page-padding: clamp(16px, 4vw, 48px);
            --radius: 2px;
        }

        * {
            box-sizing: border-box;
        }

        body {
            font-family: "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            margin: 0;
            background: radial-gradient(120% 120% at 10% 10%, #1a0f3a, transparent 55%),
                radial-gradient(120% 120% at 90% 0%, #0d0c37, transparent 60%),
                linear-gradient(135deg, #050421, #13072d 35%, #1c0836 70%, #050421);
            color: var(--text);
            padding: 0 var(--page-padding);
        }

        .nav {
            position: sticky;
            top: 0;
            z-index: 10;
            backdrop-filter: saturate(1.2) blur(8px);
            background: #0D0226;
            margin: 0 calc(var(--page-padding) * -1);
            padding: 0 var(--page-padding);
        }

        .nav-inner {
            max-width: 1080px;
            margin: 0 auto;
            padding: 12px 0;
            display: flex;
            align-items: center;
            justify-content: space-between;
            width: 100%;
        }

        .brand {
            display: flex;
            align-items: center;
            font-weight: 700;
        }

        .brand-text {
            color: #ffffff;
            font-size: 18px;
        }

        .container {
            max-width: 1080px;
            margin: 30px auto;
            padding: 0 0 40px;
            width: 100%;
        }

        .grid {
            display: grid;
            grid-template-columns: 280px 1fr;
            gap: 24px;
        }

        @media (max-width: 900px) {
            .grid {
                grid-template-columns: 1fr;
            }
        }

        .sidebar {
            position: sticky;
            top: 100px;
            align-self: start;
        }

        .sidebar-scroll {
            display: flex;
            flex-direction: column;
            gap: 24px;
            max-height: calc(100vh - 140px);
            overflow-y: auto;
            padding-right: 6px;
        }

        .sidebar-scroll::-webkit-scrollbar {
            width: 6px;
        }

        .sidebar-scroll::-webkit-scrollbar-thumb {
            background: rgba(148, 163, 184, 0.25);
            border-radius: 999px;
        }

        .card {
            background: #131313;
            border: 1px solid var(--border);
            border-radius: var(--radius);
            box-shadow: 0 4px 24px rgba(0, 0, 0, 0.35);
        }

        .card-presets,
        .card-contact,
        .card-emulator {
            background: transparent;
            border: none;
            box-shadow: none;
        }

        .card-header {
            padding: 18px 18px 0 18px;
        }

        .card-title {
            font-weight: 700;
            font-size: 18px;
        }

        .card-subtitle {
            color: var(--muted);
            font-size: 13px;
            margin-top: 6px;
        }

        .card-body {
            padding: 18px;
        }

        .preset-list {
            display: grid;
            gap: 10px;
        }

        .preset-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }

        .preset-btn {
            text-align: left;
            background: #0D0226;
            border: 1px solid rgba(108, 88, 190, 0.8);
            padding: 12px 14px;
            border-radius: var(--radius);
            cursor: pointer;
            transition: box-shadow .2s, transform .05s, border-color .2s, background .2s;
            color: #d5cff6;
        }

        .preset-btn:hover {
            border-color: rgba(200, 170, 255, 0.95);
            background: #120735;
            box-shadow: 0 0 10px rgba(108, 88, 190, 0.4);
        }

        .preset-title {
            font-weight: 600;
            font-size: 14px;
        }

        .preset-desc {
            display: none;
        }

        .field {
            margin-bottom: 16px;
        }

        .label {
            display: block;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .input,
        .textarea {
            width: 100%;
            border: 1.5px solid var(--border);
            background: #0D0226;
            color: var(--text);
            border-radius: var(--radius);
            padding: 12px 14px;
            font-size: 14px;
            outline: none;
            transition: border-color .2s, box-shadow .2s, background .2s;
        }

        .input::placeholder,
        .textarea::placeholder {
            color: #c7bddf;
            opacity: 1;
        }

        .input:focus,
        .textarea:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 6px var(--ring);
        }

        .textarea {
            min-height: 120px;
            resize: vertical;
        }

        .actions {
            display: flex;
            gap: 12px;
            align-items: center;
            flex-wrap: wrap;
        }

        .actions.is-inline {
            flex-wrap: nowrap;
        }

        .actions.is-inline .btn {
            padding: 10px 14px;
            font-size: 13px;
        }

        .btn {
            border: 1px solid rgba(255, 255, 255, 0.15);
            padding: 10px 16px;
            border-radius: var(--radius);
            color: #050421;
            font-weight: 600;
            cursor: pointer;
            transition: transform .05s ease, box-shadow .2s ease, filter .2s ease;
            background: #ffffff;
            box-shadow: none;
        }

        .btn:hover {
            filter: brightness(1.1);
            box-shadow: none;
        }

        .btn-ghost,
        .btn-secondary {
            background: #ffffff;
            color: #050421;
            border: 1px solid rgba(255, 255, 255, 0.15);
            border-radius: var(--radius);
        }

        .btn-icon {
            font-size: 18px;
            line-height: 1;
            display: inline-block;
        }

        .pill {
            padding: 6px 10px;
            border-radius: 999px;
            font-size: 12px;
            font-weight: 700;
        }

        .pill.loading {
            background: #fbbf24;
            color: #1f2937;
        }

        .pill.success {
            background: #166534;
            color: #dcfce7;
        }

        .pill.error {
            background: #991b1b;
            color: #fee2e2;
        }

        .response-box {
            border: 1px solid rgba(255, 255, 255, 0.12);
            border-radius: var(--radius);
            background: #0D0226;
            box-shadow: 0 12px 36px rgba(3, 3, 20, 0.55);
            overflow: hidden;
            margin-top: 12px;
        }

        .response-meta {
            display: flex;
            gap: 14px;
            padding: 10px 12px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.08);
            color: #d5cff6;
            background: #120735;
            font-size: 12px;
        }

        .response-view-label {
            margin-left: auto;
            padding: 2px 10px;
            border: 1px solid rgba(255, 255, 255, 0.15);
            border-radius: 999px;
            font-size: 11px;
            letter-spacing: 0.05em;
            color: #d5cff6;
            display: none;
        }

        .code {
            padding: 14px;
            font-family: ui-monospace, SFMono-Regular, Menlo, Monaco;
            font-size: 13px;
            white-space: pre-wrap;
            max-height: 360px;
            overflow: auto;
            background: #050421;
            color: #f1f4ff;
        }

        .pane {
            border: 1px solid rgba(255, 255, 255, 0.12);
            border-radius: var(--radius);
            background: #050421;
        }

        .response-body {
            background: #050421;
            border: 1px solid rgba(255, 255, 255, 0.15);
            border-radius: var(--radius);
            padding: 16px;
            color: #f8f8ff;
            line-height: 1.6;
            box-shadow: 0 4px 24px rgba(3, 3, 20, 0.45);
        }

        .wa-inline {
            background: #1c2430;
            color: #e6edf3;
        }

        .wa-code {
            background: #0b1220;
            color: #e2e8f0;
            padding: 10px 12px;
            border-radius: var(--radius);
            overflow: auto;
            font-size: 12px;
        }

        .info-badge {
            display: inline-block;
            margin-left: 6px;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: #30363d;
            color: #e6edf3;
            font-size: 11px;
            font-weight: 800;
            text-align: center;
            line-height: 16px;
            cursor: help;
        }
    </style>
</head>

<body>
    <div class="nav">
        <div class="nav-inner">
            <div class="brand">
                <div class="brand-text">LogLife Emulator</div>
            </div>
        </div>
    </div>

    <div class="container">
        <div class="grid">
            <div class="sidebar">
                <div class="sidebar-scroll">
                    <div class="card card-presets">
                        <div class="card-header">
                            <div class="card-title">Quick Presets</div>
                        </div>
                        <div class="card-body">
                            <div class="preset-list">
                                <button class="preset-btn" data-msg="goals">
                                    <div class="preset-title">Goals</div>
                                </button>
                                <div class="preset-row">
                                    <button class="preset-btn" data-msg="add goal üìñ Read 20 pages daily">
                                        <div class="preset-title">Add Goal</div>
                                    </button>
                                    <button class="preset-btn" data-msg="6 PM">
                                        <div class="preset-title">Reminder Time</div>
                                    </button>
                                </div>
                                <button class="preset-btn" data-msg="rate 1 3">
                                    <div class="preset-title">Rate Goal</div>
                                </button>
                                <button class="preset-btn" data-msg="week">
                                    <div class="preset-title">Weekly Summary</div>
                                </button>
                                <button class="preset-btn" data-msg="31232">
                                    <div class="preset-title">Rate All Goals</div>
                                </button>
                                <button class="preset-btn" data-msg="lookback 7">
                                    <div class="preset-title">Lookback</div>
                                </button>
                                <button class="preset-btn" data-msg="help">
                                    <div class="preset-title">Help</div>
                                </button>
                                <div class="preset-row">
                                    <button class="preset-btn" data-msg="update 1 6 PM">
                                        <div class="preset-title">Update Reminder</div>
                                    </button>
                                    <button class="preset-btn" data-msg="delete 1">
                                        <div class="preset-title">Delete Goal</div>
                                    </button>
                                </div>
                                <div class="preset-row">
                                    <button class="preset-btn" data-msg="transcript on">
                                        <div class="preset-title">Enable Transcription</div>
                                    </button>
                                    <button class="preset-btn" data-msg="transcript off">
                                        <div class="preset-title">Disable Transcription</div>
                                    </button>
                                </div>
                                <button class="preset-btn" id="testAudioBtn">
                                    <div class="preset-title">Send Audio</div>
                                </button>
                                <button class="preset-btn" id="stopAudioBtn"
                                    style="display:none; background: #fee2e2; border-color: #fca5a5;">
                                    <div class="preset-title">‚èπÔ∏è Stop Recording</div>
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="card card-contact">
                        <div class="card-header">
                            <div class="card-title">Share Contact</div>
                        </div>
                        <div class="card-body">
                            <div class="field">
                                <label class="label" for="waidInput">WhatsApp ID (number)
                                    <span class="info-badge"
                                        title="Include country code, no + or spaces. Example: 923325727426">i</span>
                                </label>
                                <input class="input" id="waidInput" name="waidInput" placeholder="e.g., 923325727426" />
                            </div>

                            <div class="actions is-inline">
                                <button type="button" class="btn" id="sendContactBtn">Send Contact</button>
                                <button type="button" class="btn btn-ghost" id="fillSampleContactBtn">Fill
                                    Sample</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="card card-emulator" id="emulatorCard">
                <div class="card-header">
                    <div class="card-title">Send Test Request</div>
                </div>
                <div class="card-body">
                    <form id="emulatorForm">
                        <div class="field">
                            <label class="label" for="sender">Sender (from)</label>
                            <input class="input" type="text" id="sender" name="sender" value="test_user"
                                placeholder="Enter sender identifier">
                        </div>
                        <div class="field">
                            <label class="label" for="message">Message</label>
                            <textarea class="textarea" id="message" name="message"
                                placeholder="Enter your message here..." required></textarea>
                        </div>
                        <div class="actions">
                            <button type="submit" class="btn" id="submitBtn">Send Request</button>
                            <button type="button" class="btn btn-secondary" id="resetBtn" title="Reset form"
                                aria-label="Reset form">
                                <span class="btn-icon" aria-hidden="true">&#10227;</span>
                            </button>
                            <button type="button" class="btn btn-ghost" id="clearBtn" title="Clear message"
                                aria-label="Clear message">
                                <span class="btn-icon" aria-hidden="true">&#128465;</span>
                            </button>
                        </div>
                    </form>

                    <div style="height: 14px"></div>

                    <div class="response-toolbar">
                        <div style="display:flex; align-items:center; gap:12px">
                            <div id="statusPill" class="pill" style="display:none"></div>
                            <div class="response-view-label">WhatsApp</div>
                        </div>
                    </div>

                    <div id="responseBox" class="response-box" style="display:none">
                        <div class="response-meta" id="responseMeta">
                            <div id="metaStatus">Status: ‚Äì</div>
                            <div id="metaTime">Time: ‚Äì</div>
                            <div id="metaSize">Size: ‚Äì</div>
                        </div>
                        <div style="padding: 12px">
                            <div class="response-body" id="waBubble">‚Äî</div>
                            <pre id="responseContent" style="display:none"></pre>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- <div class="footer">Designed for internal testing ‚Ä¢ /webhook endpoint</div> -->
    </div>

    <script>
        const byId = (id) => document.getElementById(id);

        const form = byId('emulatorForm');
        const senderEl = byId('sender');
        const messageEl = byId('message');
        const submitBtn = byId('submitBtn');
        const clearBtn = byId('clearBtn');
        const resetBtn = byId('resetBtn');
        const statusPill = byId('statusPill');
        const responseBox = byId('responseBox');
        const responseContent = byId('responseContent');
        const metaStatus = byId('metaStatus');
        const metaTime = byId('metaTime');
        const metaSize = byId('metaSize');
        const waBubble = byId('waBubble');
        const waidInputEl = byId('waidInput');
        const sendContactBtn = byId('sendContactBtn');
        const fillSampleContactBtn = byId('fillSampleContactBtn');
        const testAudioBtn = byId('testAudioBtn');
        const stopAudioBtn = byId('stopAudioBtn');


        let mediaRecorder = null;
        let audioChunks = [];

        // Quick Presets
        document.querySelectorAll('.preset-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                messageEl.value = btn.getAttribute('data-msg');
                messageEl.focus();
            });
        });

        clearBtn.addEventListener('click', () => {
            messageEl.value = '';
            responseBox.style.display = 'none';
            document.querySelector('.response-view-label').style.display = 'none';
            statusPill.style.display = 'none';
        });

        resetBtn.addEventListener('click', () => {
            senderEl.value = 'test_user';
            messageEl.value = '';
            responseBox.style.display = 'none';
            document.querySelector('.response-view-label').style.display = 'none';
            statusPill.style.display = 'none';
        });

        function setStatus(mode, text) {
            statusPill.className = 'pill ' + mode;
            statusPill.textContent = text;
            statusPill.style.display = 'inline-block';
        }

        function toWhatsAppPreview(raw) {
            if (!raw) return '';
            // Preserve simple formatting that our bot returns (emojis, bullets, lines)
            let text = String(raw);
            // Remove all backticks from the text
            text = text.replace(/`/g, '');
            // Replace markdown-like emphasis with simple HTML
            text = text
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1<\/strong>')
                .replace(/\*(.*?)\*/g, '<em>$1<\/em>')
                .replace(/_(.*?)_/g, '<em>$1<\/em>');
            // Convert list hyphens to real list for nicer visual if multiple lines
            if (/^-\s/m.test(text)) {
                const lines = text.split(/\r?\n/);
                const items = [];
                let inList = false;
                const out = [];
                for (const line of lines) {
                    if (/^-\s/.test(line)) {
                        inList = true;
                        items.push('<li>' + line.replace(/^-\s*/, '') + '<\/li>');
                    } else {
                        if (inList) {
                            out.push('<ul class="wa-list">' + items.join('') + '<\/ul>');
                            items.length = 0;
                            inList = false;
                        }
                        out.push(line);
                    }
                }
                if (items.length) out.push('<ul class="wa-list">' + items.join('') + '<\/ul>');
                text = out.join('\n');
            }
            // Convert numbered lists to ordered lists
            if (/^\d+\.\s/m.test(text)) {
                const lines = text.split(/\r?\n/);
                const items = [];
                let inOrdered = false;
                const out = [];
                for (const line of lines) {
                    if (/^\d+\.\s/.test(line)) {
                        inOrdered = true;
                        items.push('<li>' + line.replace(/^\d+\.\s*/, '') + '<\/li>');
                    } else {
                        if (inOrdered) {
                            out.push('<ol class="wa-list">' + items.join('') + '<\/ol>');
                            items.length = 0;
                            inOrdered = false;
                        }
                        out.push(line);
                    }
                }
                if (items.length) out.push('<ol class="wa-list">' + items.join('') + '<\/ol>');
                text = out.join('\n');
            }
            // Replace new lines with <br>
            text = text.replace(/\r?\n/g, '<br>');
            return text;
        }

        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            const payload = { sender: senderEl.value, msg_type: 'chat', raw_msg: messageEl.value };

            // UI loading state
            submitBtn.disabled = true;
            submitBtn.textContent = 'Sending‚Ä¶';
            setStatus('loading', 'Sending');
            responseBox.style.display = 'block';
            document.querySelector('.response-view-label').style.display = 'inline-block';
            responseContent.textContent = '';
            waBubble.textContent = '‚Äî';

            const start = performance.now();
            let text = '';
            let ok = false;
            let size = 0;
            try {
                const res = await fetch('/webhook', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                ok = res.ok;
                // Try JSON first, fallback to text
                let formattedText = '';
                try {
                    const data = await res.clone().json();
                    text = JSON.stringify(data, null, 2);
                    // Extract message from new JSON structure: data.data.message for success, data.message for errors
                    const previewCandidate = (data && (
                        (data.data && data.data.message) ||  // New format: success case
                        data.message ||                      // Error case or old format
                        data.text ||
                        data.response
                    )) || '';
                    if (previewCandidate) {
                        formattedText = previewCandidate;
                    } else {
                        // If the handler returns JSON-encoded string under body
                        if (typeof data === 'string') {
                            formattedText = data;
                        } else {
                            formattedText = text;
                        }
                    }
                } catch {
                    text = await res.text();
                    formattedText = text;
                }
                size = (text || '').length;

                const ms = Math.max(1, Math.round(performance.now() - start));
                metaStatus.textContent = 'Status: ' + res.status + (ok ? ' OK' : ' ERROR');
                metaTime.textContent = 'Time: ' + ms + ' ms';
                metaSize.textContent = 'Size: ' + size + ' chars';

                // Populate both views
                responseContent.textContent = text || '(empty response)';
                waBubble.innerHTML = toWhatsAppPreview(formattedText);

                setStatus(ok ? 'success' : 'error', ok ? 'Success' : 'Error');
            } catch (err) {
                const ms = Math.max(1, Math.round(performance.now() - start));
                metaStatus.textContent = 'Status: NETWORK ERROR';
                metaTime.textContent = 'Time: ' + ms + ' ms';
                metaSize.textContent = 'Size: 0 chars';
                responseContent.textContent = 'Network error: ' + (err && err.message ? err.message : 'Unknown');
                setStatus('error', 'Network Error');
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = 'Send Request';
            }
        });

        fillSampleContactBtn.addEventListener('click', () => {
            waidInputEl.value = '923325727426';
            waidInputEl.focus();
        });

        sendContactBtn.addEventListener('click', async () => {
            const waid = (waidInputEl.value || '').trim();
            if (!waid) {
                setStatus('error', 'Enter WhatsApp ID');
                return;
            }
            // Use WAID as-is (expecting full number with country code)
            const derivedPhone = waid;
            // Display number (format for display only)
            const displayNumber = waid;
            // Construct a VCARD that backend expects
            const vcard = `BEGIN:VCARD\nVERSION:3.0\nN:;${derivedPhone};;;\nFN:${derivedPhone}\nTEL;type=CELL;waid=${waid}:${displayNumber}\nEND:VCARD`;
            const payload = { sender: senderEl.value, msg_type: 'vcard', raw_msg: vcard };

            // UI loading state
            setStatus('loading', 'Sending Contact');
            responseBox.style.display = 'block';
            document.querySelector('.response-view-label').style.display = 'inline-block';
            responseContent.textContent = '';
            waBubble.textContent = '‚Äî';

            const start = performance.now();
            try {
                const res = await fetch('/webhook', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                const ok = res.ok;
                let text = '';
                let formattedText = '';
                try {
                    const data = await res.clone().json();
                    text = JSON.stringify(data, null, 2);
                    // Extract message from new JSON structure: data.data.message for success, data.message for errors
                    formattedText = (data && (
                        (data.data && data.data.message) ||  // New format: success case
                        data.message ||                      // Error case or old format
                        data.text ||
                        data.response
                    )) || text;
                } catch {
                    text = await res.text();
                    formattedText = text;
                }

                const ms = Math.max(1, Math.round(performance.now() - start));
                metaStatus.textContent = 'Status: ' + res.status + (ok ? ' OK' : ' ERROR');
                metaTime.textContent = 'Time: ' + ms + ' ms';
                metaSize.textContent = 'Size: ' + (text || '').length + ' chars';

                responseContent.textContent = text || '(empty response)';
                waBubble.innerHTML = toWhatsAppPreview(formattedText);
                setStatus(ok ? 'success' : 'error', ok ? 'Success' : 'Error');
            } catch (err) {
                const ms = Math.max(1, Math.round(performance.now() - start));
                metaStatus.textContent = 'Status: NETWORK ERROR';
                metaTime.textContent = 'Time: ' + ms + ' ms';
                metaSize.textContent = 'Size: 0 chars';
                responseContent.textContent = 'Network error: ' + (err && err.message ? err.message : 'Unknown');
                setStatus('error', 'Network Error');
            }
        });

        // Start recording audio
        testAudioBtn.addEventListener('click', async () => {
            try {
                // Request microphone access
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });

                // Initialize MediaRecorder with appropriate format
                const options = { mimeType: 'audio/webm;codecs=opus' };

                // Fallback for browsers that don't support webm/opus
                if (!MediaRecorder.isTypeSupported(options.mimeType)) {
                    options.mimeType = 'audio/webm';
                    if (!MediaRecorder.isTypeSupported(options.mimeType)) {
                        options.mimeType = '';  // Let browser choose
                    }
                }

                mediaRecorder = new MediaRecorder(stream, options.mimeType ? options : undefined);
                audioChunks = [];

                // Track recording start time for duration
                const recordingStartTime = Date.now();
                mediaRecorder.recordingStartTime = recordingStartTime;

                // Collect audio data
                mediaRecorder.addEventListener('dataavailable', event => {
                    audioChunks.push(event.data);
                });

                // Start recording
                mediaRecorder.start();

                // Update UI
                testAudioBtn.style.display = 'none';
                stopAudioBtn.style.display = 'block';
                setStatus('loading', 'üî¥ Recording...');
                statusPill.style.display = 'inline-block';

            } catch (err) {
                setStatus('error', 'Microphone access denied');
                statusPill.style.display = 'inline-block';
                console.error('Error accessing microphone:', err);
            }
        });

        // Stop recording and send audio
        stopAudioBtn.addEventListener('click', async () => {
            if (!mediaRecorder || mediaRecorder.state === 'inactive') {
                return;
            }

            // Calculate duration
            const recordingDuration = Math.round((Date.now() - mediaRecorder.recordingStartTime) / 1000);

            // Stop recording
            mediaRecorder.stop();

            // Stop all tracks to release the microphone
            mediaRecorder.stream.getTracks().forEach(track => track.stop());

            mediaRecorder.addEventListener('stop', async () => {
                // Get the mimetype that was actually used
                const actualMimeType = mediaRecorder.mimeType || 'audio/webm';

                // Create audio blob from chunks
                const audioBlob = new Blob(audioChunks, { type: actualMimeType });

                // Convert to base64
                const reader = new FileReader();
                reader.readAsDataURL(audioBlob);

                reader.onloadend = async () => {
                    const base64Audio = reader.result.split(',')[1]; // Remove data:audio/...;base64, prefix

                    // Prepare payload matching WhatsApp client format
                    const payload = { sender: senderEl.value, msg_type: 'ptt', raw_msg: base64Audio };

                    // UI loading state
                    setStatus('loading', 'Sending Audio');
                    responseBox.style.display = 'block';
                    document.querySelector('.response-view-label').style.display = 'inline-block';
                    responseContent.textContent = '';
                    waBubble.textContent = '‚Äî';

                    const start = performance.now();
                    try {
                        const res = await fetch('/webhook', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(payload)
                        });

                        const ok = res.ok;
                        let text = '';
                        let formattedText = '';
                        try {
                            const data = await res.clone().json();
                            text = JSON.stringify(data, null, 2);
                            // Extract message from new JSON structure: data.data.message for success, data.message for errors
                            formattedText = (data && (
                                (data.data && data.data.message) ||  // New format: success case
                                data.message ||                      // Error case or old format
                                data.text ||
                                data.response
                            )) || text;
                        } catch {
                            text = await res.text();
                            formattedText = text;
                        }

                        const ms = Math.max(1, Math.round(performance.now() - start));
                        metaStatus.textContent = 'Status: ' + res.status + (ok ? ' OK' : ' ERROR');
                        metaTime.textContent = 'Time: ' + ms + ' ms';
                        metaSize.textContent = 'Size: ' + (text || '').length + ' chars';

                        responseContent.textContent = text || '(empty response)';
                        waBubble.innerHTML = toWhatsAppPreview(formattedText);
                        setStatus(ok ? 'success' : 'error', ok ? 'Success' : 'Error');
                    } catch (err) {
                        const ms = Math.max(1, Math.round(performance.now() - start));
                        metaStatus.textContent = 'Status: NETWORK ERROR';
                        metaTime.textContent = 'Time: ' + ms + ' ms';
                        metaSize.textContent = 'Size: 0 chars';
                        responseContent.textContent = 'Network error: ' + (err && err.message ? err.message : 'Unknown');
                        setStatus('error', 'Network Error');
                    } finally {
                        // Reset UI
                        testAudioBtn.style.display = 'block';
                        stopAudioBtn.style.display = 'none';
                    }
                };
            });
        });


    </script>
</body>

</html>