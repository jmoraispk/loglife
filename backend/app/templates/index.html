<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Life Bot Emulator</title>
    <style>
        :root {
            --bg: #f6f7fb;
            --card: #ffffff;
            --text: #1e293b;
            --muted: #64748b;
            --border: #e5e7eb;
            --primary: #2563eb;
            --primary-600: #1d4ed8;
            --accent: linear-gradient(135deg, #60a5fa, #3b82f6 45%, #2563eb 90%);
            --ring: rgba(37, 99, 235, 0.15);
        }

        * { box-sizing: border-box; }

        body {
            font-family: "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            margin: 0;
            background:
                radial-gradient(1200px 400px at 20% -50%, rgba(37,99,235,0.06), transparent 60%),
                radial-gradient(900px 300px at 100% 0%, rgba(59,130,246,0.07), transparent 60%),
                var(--bg);
            color: var(--text);
        }

        .nav {
            position: sticky;
            top: 0;
            z-index: 10;
            backdrop-filter: saturate(1.2) blur(8px);
            background: rgba(255,255,255,0.7);
            border-bottom: 1px solid var(--border);
        }

        .nav-inner {
            max-width: 1080px;
            margin: 0 auto;
            padding: 14px 24px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .brand {
            display: flex;
            align-items: center;
            gap: 12px;
            font-weight: 700;
            letter-spacing: 0.2px;
        }

        .brand-badge {
            width: 36px;
            height: 36px;
            border-radius: 10px;
            background: var(--accent);
            box-shadow: 0 6px 18px rgba(37,99,235,0.25);
        }

        .brand-text {
            background: var(--accent);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
        }

        .container {
            max-width: 1080px;
            margin: 30px auto;
            padding: 0 24px 40px;
        }

        .grid {
            display: grid;
            grid-template-columns: 280px 1fr;
            gap: 24px;
        }
        @media (max-width: 900px) { .grid { grid-template-columns: 1fr; } }

        .sidebar {
            position: sticky;
            top: 100px;
            align-self: start;
        }

        .sidebar-scroll {
            display: flex;
            flex-direction: column;
            gap: 24px;
            max-height: calc(100vh - 140px);
            overflow-y: auto;
            padding-right: 6px;
        }

        .sidebar-scroll::-webkit-scrollbar {
            width: 6px;
        }

        .sidebar-scroll::-webkit-scrollbar-track {
            background: transparent;
        }

        .sidebar-scroll::-webkit-scrollbar-thumb {
            background: rgba(148, 163, 184, 0.4);
            border-radius: 999px;
        }

        @media (max-width: 900px) {
            .sidebar-scroll {
                max-height: none;
                overflow: visible;
                padding-right: 0;
            }
            .sidebar {
                position: static;
                top: auto;
            }
        }

        .card {
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: 14px;
            box-shadow: 0 1px 2px rgba(0,0,0,0.04), 0 8px 30px rgba(2,6,23,0.06);
        }

        .card-header {
            padding: 18px 18px 0 18px;
        }
        .card-title { font-weight: 700; font-size: 18px; }
        .card-subtitle { color: var(--muted); font-size: 13px; margin-top: 6px; }
        .card-body { padding: 18px; }

        .preset-list { display: grid; gap: 10px; }
        .preset-row { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .preset-btn {
            text-align: left;
            background: #fbfdff;
            border: 1px solid var(--border);
            padding: 12px 14px;
            border-radius: 10px;
            cursor: pointer;
            transition: box-shadow .2s, transform .05s;
        }
        .preset-btn:hover { box-shadow: 0 6px 22px var(--ring); }
        .preset-btn:active { transform: translateY(1px); }
        .preset-title { font-weight: 600; font-size: 14px; }
        .preset-desc { color: var(--muted); font-size: 12px; margin-top: 4px; }

        .field { margin-bottom: 16px; }
        .label { display: block; font-weight: 600; margin-bottom: 8px; }
        .input, .textarea {
            width: 100%;
            border: 1.5px solid var(--border);
            background: #fff;
            border-radius: 10px;
            padding: 12px 14px;
            font-size: 14px;
            outline: none;
            transition: border-color .2s, box-shadow .2s;
        }
        .input:focus, .textarea:focus { border-color: var(--primary); box-shadow: 0 0 0 6px var(--ring); }
        .textarea { min-height: 120px; resize: vertical; }

        .actions { display: flex; gap: 12px; align-items: center; }
        .btn {
            border: none;
            padding: 12px 18px;
            border-radius: 10px;
            color: white;
            font-weight: 600;
            cursor: pointer;
            transition: transform .05s ease, box-shadow .2s ease, filter .2s ease;
            background: var(--accent);
            box-shadow: 0 10px 28px rgba(37,99,235,0.25);
        }
        .btn:hover { filter: brightness(1.03); box-shadow: 0 12px 36px rgba(37,99,235,0.32); }
        .btn:active { transform: translateY(1px); }
        .btn:disabled { filter: grayscale(0.2) brightness(0.96); cursor: not-allowed; box-shadow: none; }
        .btn-secondary { background: #0f172a; box-shadow: 0 10px 28px rgba(2,6,23,0.15); }
        .btn-ghost { background: #f8fafc; color: #0f172a; border: 1px solid var(--border); box-shadow: none; }

        .response-toolbar {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 10px;
            margin-bottom: 10px;
        }
        .pill { padding: 6px 10px; border-radius: 999px; font-size: 12px; font-weight: 700; }
        .pill.loading { background: #fde68a; color: #92400e; }
        .pill.success { background: #dcfce7; color: #166534; }
        .pill.error { background: #fee2e2; color: #991b1b; }

        .toggle-switch {
            display: inline-flex;
            background: #f1f5f9;
            border-radius: 8px;
            padding: 4px;
            gap: 4px;
        }
        .toggle-btn {
            padding: 6px 14px;
            border: none;
            background: transparent;
            border-radius: 6px;
            font-size: 13px;
            font-weight: 600;
            color: #64748b;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .toggle-btn.active {
            background: white;
            color: var(--primary);
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        .toggle-btn:hover:not(.active) {
            color: #334155;
        }

        .response-box {
            border: 1px solid var(--border);
            border-radius: 10px;
            background: #fff;
            overflow: hidden;
        }
        .response-meta { display: flex; gap: 14px; padding: 10px 12px; border-bottom: 1px solid var(--border); color: var(--muted); font-size: 12px; }
        .code {
            padding: 14px;
            font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
            font-size: 13px;
            white-space: pre-wrap;
            max-height: 360px;
            overflow: auto;
            background: linear-gradient(180deg, #ffffff, #fcfdff);
        }
        .response-split { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; padding: 12px; }
        @media (max-width: 900px) { .response-split { grid-template-columns: 1fr; } }
        .pane { border: 1px solid var(--border); border-radius: 10px; background: #fff; display: flex; flex-direction: column; overflow: hidden; }
        .pane .wa-title { margin: 10px 12px 0 12px; text-transform: lowercase; letter-spacing: 0.2px; }
        .pane-body { padding: 0 0 10px 0; }

        /* WhatsApp-style preview */
        .wa-wrap { margin-top: 16px; }
        .wa-title { font-weight: 700; font-size: 14px; color: var(--muted); margin: 6px 2px; }
        .wa-box {
            background: #fefefe;
            border: 1px solid var(--border);
            border-radius: 12px;
            box-shadow: 0 1px 2px rgba(0,0,0,0.03), 0 10px 30px rgba(2,6,23,0.04);
            padding: 14px;
        }
        .wa-bubble {
            display: inline-block;
            max-width: 100%;
            background: #ffffff;
            border: 1px solid #e6edf5;
            border-radius: 14px 14px 14px 6px;
            padding: 10px 12px;
            line-height: 1.55;
            box-shadow: 0 2px 12px rgba(15,23,42,0.05);
        }
        .wa-bubble strong { font-weight: 800; }
        .wa-bubble em { font-style: italic; }
        .wa-inline { background: #f1f5f9; padding: 1px 6px; border-radius: 4px; font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; font-size: 12px; }
        .wa-code { background: #0b1220; color: #e2e8f0; padding: 10px 12px; border-radius: 8px; overflow: auto; font-size: 12px; }
        .wa-list { margin: 8px 0 0 0; padding: 0 0 0 18px; }

        .footer { text-align: center; color: var(--muted); font-size: 12px; margin-top: 22px; }

        /* small info badge */
        .info-badge {
            display: inline-block;
            margin-left: 6px;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: #e2e8f0;
            color: #0f172a;
            font-size: 11px;
            font-weight: 800;
            line-height: 16px;
            text-align: center;
            cursor: help;
        }
    </style>
</head>
<body>
    <div class="nav">
        <div class="nav-inner">
            <div class="brand">
                <div class="brand-badge"></div>
                <div class="brand-text">Life Bot Emulator</div>
            </div>
        </div>
    </div>

    <div class="container">
        <div class="grid">
            <div class="sidebar">
                <div class="sidebar-scroll">
                    <div class="card">
                        <div class="card-header">
                            <div class="card-title">Quick Presets</div>
                            <div class="card-subtitle">Insert a sample message with one click</div>
                        </div>
                        <div class="card-body">
                            <div class="preset-list">
                                <button class="preset-btn" data-msg="goals">
                                    <div class="preset-title">Goals</div>
                                    <div class="preset-desc">Shows all current goals</div>
                                </button>
                                <div class="preset-row">
                                    <button class="preset-btn" data-msg="add goal üìñ Read 20 pages daily">
                                        <div class="preset-title">Add Goal</div>
                                        <div class="preset-desc">Adds a new daily reading goal</div>
                                    </button>
                                    <button class="preset-btn" data-msg="6 PM">
                                        <div class="preset-title">Reminder Time</div>
                                        <div class="preset-desc">Inserts a sample reminder time</div>
                                    </button>
                                </div>
                                <button class="preset-btn" data-msg="rate 1 3">
                                    <div class="preset-title">Rate Goal</div>
                                    <div class="preset-desc">Rates a goal with a score</div>
                                </button>
                                <button class="preset-btn" data-msg="week">
                                    <div class="preset-title">Weekly Summary</div>
                                    <div class="preset-desc">Generates a progress summary</div>
                                </button>
                                <button class="preset-btn" data-msg="31232">
                                    <div class="preset-title">Rate All Goals</div>
                                    <div class="preset-desc">Rate all goals at once</div>
                                </button>
                                <button class="preset-btn" data-msg="lookback 7">
                                    <div class="preset-title">Lookback</div>
                                    <div class="preset-desc">Show last 7 days</div>
                                </button>
                                <button class="preset-btn" data-msg="help">
                                    <div class="preset-title">Help</div>
                                    <div class="preset-desc">Show available commands</div>
                                </button>
                                <button class="preset-btn" id="testAudioBtn">
                                    <div class="preset-title">Send Audio</div>
                                    <div class="preset-desc">Record & send audio</div>
                                </button>
                                <button class="preset-btn" id="stopAudioBtn" style="display:none; background: #fee2e2; border-color: #fca5a5;">
                                    <div class="preset-title">‚èπÔ∏è Stop Recording</div>
                                    <div class="preset-desc">Stop and send audio</div>
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="card">
                        <div class="card-header">
                            <div class="card-title">Share Contact</div>
                            <div class="card-subtitle">Enter WhatsApp ID (number) to emulate VCARD sharing</div>
                        </div>
                        <div class="card-body">
                            <div class="field">
                                <label class="label" for="waidInput">WhatsApp ID (number)
                                    <span class="info-badge" title="Include country code, no + or spaces. Example: 923325727426">i</span>
                                </label>
                                <input class="input" id="waidInput" name="waidInput" placeholder="e.g., 923325727426" />
                            </div>
                            
                            <div class="actions">
                                <button type="button" class="btn" id="sendContactBtn">Send Contact</button>
                                <button type="button" class="btn btn-ghost" id="fillSampleContactBtn">Fill Sample</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="card" id="emulatorCard">
                <div class="card-header">
                    <div class="card-title">Send Test Request</div>
                    <div class="card-subtitle">Posts JSON to /process without reloading the page</div>
                </div>
                <div class="card-body">
                    <form id="emulatorForm">
                        <div class="field">
                            <label class="label" for="sender">Sender (from)</label>
                            <input class="input" type="text" id="sender" name="sender" value="test_user" placeholder="Enter sender identifier">
                        </div>
                        <div class="field">
                            <label class="label" for="message">Message</label>
                            <textarea class="textarea" id="message" name="message" placeholder="Enter your message here..." required></textarea>
                        </div>
                        <div class="actions">
                            <button type="submit" class="btn" id="submitBtn">Send Request</button>
                            <button type="button" class="btn btn-ghost" id="clearBtn">Clear</button>
                        </div>
                    </form>

                    <div style="height: 14px"></div>

                    <div class="response-toolbar">
                        <div style="display:flex; align-items:center; gap:12px">
                            <div id="statusPill" class="pill" style="display:none"></div>
                            <div class="toggle-switch" id="previewToggle" style="display:none">
                                <button class="toggle-btn active" data-view="formatted">Formatted</button>
                                <button class="toggle-btn" data-view="actual">WhatsApp</button>
                            </div>
                        </div>
                        <div style="display:flex; gap:10px">
                            <button class="btn btn-secondary" id="copyBtn" title="Copy response" style="display:none">Copy</button>
                            <button class="btn btn-ghost" id="resetBtn" title="Reset">Reset</button>
                        </div>
                    </div>

                    <div id="responseBox" class="response-box" style="display:none">
                        <div class="response-meta" id="responseMeta">
                            <div id="metaStatus">Status: ‚Äì</div>
                            <div id="metaTime">Time: ‚Äì</div>
                            <div id="metaSize">Size: ‚Äì</div>
                        </div>
                        <div style="padding: 12px">
                            <div id="actualView" style="display:none">
                                <pre id="responseContent" class="code" style="margin:0"></pre>
                            </div>
                            <div id="formattedView">
                                <div class="wa-box">
                                    <div class="wa-bubble" id="waBubble">‚Äî</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- <div class="footer">Designed for internal testing ‚Ä¢ /process endpoint</div> -->
    </div>

    <script>
        const byId = (id) => document.getElementById(id);

        const form = byId('emulatorForm');
        const senderEl = byId('sender');
        const messageEl = byId('message');
        const submitBtn = byId('submitBtn');
        const clearBtn = byId('clearBtn');
        const resetBtn = byId('resetBtn');
        const copyBtn = byId('copyBtn');
        const statusPill = byId('statusPill');
        const responseBox = byId('responseBox');
        const responseContent = byId('responseContent');
        const metaStatus = byId('metaStatus');
        const metaTime = byId('metaTime');
        const metaSize = byId('metaSize');
        const previewToggle = byId('previewToggle');
        const actualView = byId('actualView');
        const formattedView = byId('formattedView');
        const waBubble = byId('waBubble');
        const waidInputEl = byId('waidInput');
        const sendContactBtn = byId('sendContactBtn');
        const fillSampleContactBtn = byId('fillSampleContactBtn');
        const testAudioBtn = byId('testAudioBtn');
        const stopAudioBtn = byId('stopAudioBtn');
        

        let currentView = 'formatted';
        let mediaRecorder = null;
        let audioChunks = [];

        // Quick Presets
        document.querySelectorAll('.preset-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                messageEl.value = btn.getAttribute('data-msg');
                messageEl.focus();
            });
        });

        // Toggle between actual and formatted views
        previewToggle.querySelectorAll('.toggle-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                const view = btn.getAttribute('data-view');
                currentView = view;
                
                // Update active state
                previewToggle.querySelectorAll('.toggle-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                
                // Show/hide views
                if (view === 'actual') {
                    actualView.style.display = 'block';
                    formattedView.style.display = 'none';
                } else {
                    actualView.style.display = 'none';
                    formattedView.style.display = 'block';
                }
            });
        });

        clearBtn.addEventListener('click', () => {
            messageEl.value = '';
            responseBox.style.display = 'none';
            statusPill.style.display = 'none';
            copyBtn.style.display = 'none';
            previewToggle.style.display = 'none';
        });

        resetBtn.addEventListener('click', () => {
            senderEl.value = 'test_user';
            messageEl.value = '';
            responseBox.style.display = 'none';
            statusPill.style.display = 'none';
            copyBtn.style.display = 'none';
            previewToggle.style.display = 'none';
        });

        copyBtn.addEventListener('click', async () => {
            try {
                let textToCopy = '';
                if (currentView === 'actual') {
                    textToCopy = responseContent.textContent;
                } else {
                    textToCopy = waBubble.textContent;
                }
                await navigator.clipboard.writeText(textToCopy);
                copyBtn.textContent = 'Copied!';
                setTimeout(() => (copyBtn.textContent = 'Copy'), 1200);
            } catch {}
        });

        function setStatus(mode, text) {
            statusPill.className = 'pill ' + mode;
            statusPill.textContent = text;
            statusPill.style.display = 'inline-block';
        }

        function toWhatsAppPreview(raw) {
            if (!raw) return '';
            // Preserve simple formatting that our bot returns (emojis, bullets, lines)
            let text = String(raw);
            // Remove all backticks from the text
            text = text.replace(/`/g, '');
            // Replace markdown-like emphasis with simple HTML
            text = text
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1<\/strong>')
                .replace(/\*(.*?)\*/g, '<em>$1<\/em>');
            // Convert list hyphens to real list for nicer visual if multiple lines
            if (/^-\s/m.test(text)) {
                const lines = text.split(/\r?\n/);
                const items = [];
                let inList = false;
                const out = [];
                for (const line of lines) {
                    if (/^-\s/.test(line)) {
                        inList = true;
                        items.push('<li>' + line.replace(/^-\s*/, '') + '<\/li>');
                    } else {
                        if (inList) {
                            out.push('<ul class="wa-list">' + items.join('') + '<\/ul>');
                            items.length = 0;
                            inList = false;
                        }
                        out.push(line);
                    }
                }
                if (items.length) out.push('<ul class="wa-list">' + items.join('') + '<\/ul>');
                text = out.join('\n');
            }
            // Replace new lines with <br>
            text = text.replace(/\r?\n/g, '<br>');
            return text;
        }

        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            const payload = { from: senderEl.value, message: messageEl.value };

            // UI loading state
            submitBtn.disabled = true;
            submitBtn.textContent = 'Sending‚Ä¶';
            setStatus('loading', 'Sending');
            responseBox.style.display = 'block';
            previewToggle.style.display = 'inline-flex';
            responseContent.textContent = '';
            waBubble.textContent = '‚Äî';
            copyBtn.style.display = 'none';
            
            // Show the current view
            if (currentView === 'actual') {
                actualView.style.display = 'block';
                formattedView.style.display = 'none';
            } else {
                actualView.style.display = 'none';
                formattedView.style.display = 'block';
            }

            const start = performance.now();
            let text = '';
            let ok = false;
            let size = 0;
            try {
                const res = await fetch('/process', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                ok = res.ok;
                // Try JSON first, fallback to text
                let formattedText = '';
                try {
                    const data = await res.clone().json();
                    text = JSON.stringify(data, null, 2);
                    // Best-effort preview: if server returns JSON with "message" or "text"
                    const previewCandidate = (data && (data.message || data.text || data.response)) || '';
                    if (previewCandidate) {
                        formattedText = previewCandidate;
                    } else {
                        // If the handler returns JSON-encoded string under body
                        if (typeof data === 'string') {
                            formattedText = data;
                        } else {
                            formattedText = text;
                        }
                    }
                } catch {
                    text = await res.text();
                    formattedText = text;
                }
                size = (text || '').length;

                const ms = Math.max(1, Math.round(performance.now() - start));
                metaStatus.textContent = 'Status: ' + res.status + (ok ? ' OK' : ' ERROR');
                metaTime.textContent = 'Time: ' + ms + ' ms';
                metaSize.textContent = 'Size: ' + size + ' chars';

                // Populate both views
                responseContent.textContent = text || '(empty response)';
                waBubble.innerHTML = toWhatsAppPreview(formattedText);
                
                setStatus(ok ? 'success' : 'error', ok ? 'Success' : 'Error');
                copyBtn.style.display = 'inline-block';
            } catch (err) {
                const ms = Math.max(1, Math.round(performance.now() - start));
                metaStatus.textContent = 'Status: NETWORK ERROR';
                metaTime.textContent = 'Time: ' + ms + ' ms';
                metaSize.textContent = 'Size: 0 chars';
                responseContent.textContent = 'Network error: ' + (err && err.message ? err.message : 'Unknown');
                setStatus('error', 'Network Error');
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = 'Send Request';
            }
        });

        fillSampleContactBtn.addEventListener('click', () => {
            waidInputEl.value = '923325727426';
            waidInputEl.focus();
        });

        sendContactBtn.addEventListener('click', async () => {
            const waid = (waidInputEl.value || '').trim();
            if (!waid) {
                setStatus('error', 'Enter WhatsApp ID');
                return;
            }
            // Use WAID as-is (expecting full number with country code)
            const derivedPhone = waid;
            // Display number (format for display only)
            const displayNumber = waid;
            // Construct a VCARD that backend expects
            const vcard = `BEGIN:VCARD\nVERSION:3.0\nN:;${derivedPhone};;;\nFN:${derivedPhone}\nTEL;type=CELL;waid=${waid}:${displayNumber}\nEND:VCARD`;
            const payload = { from: senderEl.value, message: vcard };

            // UI loading state
            setStatus('loading', 'Sending Contact');
            responseBox.style.display = 'block';
            previewToggle.style.display = 'inline-flex';
            responseContent.textContent = '';
            waBubble.textContent = '‚Äî';
            copyBtn.style.display = 'none';

            // Show current view
            if (currentView === 'actual') {
                actualView.style.display = 'block';
                formattedView.style.display = 'none';
            } else {
                actualView.style.display = 'none';
                formattedView.style.display = 'block';
            }

            const start = performance.now();
            try {
                const res = await fetch('/process', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                const ok = res.ok;
                let text = '';
                let formattedText = '';
                try {
                    const data = await res.clone().json();
                    text = JSON.stringify(data, null, 2);
                    formattedText = (data && (data.message || data.text || data.response)) || text;
                } catch {
                    text = await res.text();
                    formattedText = text;
                }

                const ms = Math.max(1, Math.round(performance.now() - start));
                metaStatus.textContent = 'Status: ' + res.status + (ok ? ' OK' : ' ERROR');
                metaTime.textContent = 'Time: ' + ms + ' ms';
                metaSize.textContent = 'Size: ' + (text || '').length + ' chars';

                responseContent.textContent = text || '(empty response)';
                waBubble.innerHTML = toWhatsAppPreview(formattedText);
                setStatus(ok ? 'success' : 'error', ok ? 'Success' : 'Error');
                copyBtn.style.display = 'inline-block';
            } catch (err) {
                const ms = Math.max(1, Math.round(performance.now() - start));
                metaStatus.textContent = 'Status: NETWORK ERROR';
                metaTime.textContent = 'Time: ' + ms + ' ms';
                metaSize.textContent = 'Size: 0 chars';
                responseContent.textContent = 'Network error: ' + (err && err.message ? err.message : 'Unknown');
                setStatus('error', 'Network Error');
            }
        });

        // Start recording audio
        testAudioBtn.addEventListener('click', async () => {
            try {
                // Request microphone access
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                
                // Initialize MediaRecorder with appropriate format
                const options = { mimeType: 'audio/webm;codecs=opus' };
                
                // Fallback for browsers that don't support webm/opus
                if (!MediaRecorder.isTypeSupported(options.mimeType)) {
                    options.mimeType = 'audio/webm';
                    if (!MediaRecorder.isTypeSupported(options.mimeType)) {
                        options.mimeType = '';  // Let browser choose
                    }
                }
                
                mediaRecorder = new MediaRecorder(stream, options.mimeType ? options : undefined);
                audioChunks = [];
                
                // Track recording start time for duration
                const recordingStartTime = Date.now();
                mediaRecorder.recordingStartTime = recordingStartTime;
                
                // Collect audio data
                mediaRecorder.addEventListener('dataavailable', event => {
                    audioChunks.push(event.data);
                });
                
                // Start recording
                mediaRecorder.start();
                
                // Update UI
                testAudioBtn.style.display = 'none';
                stopAudioBtn.style.display = 'block';
                setStatus('loading', 'üî¥ Recording...');
                statusPill.style.display = 'inline-block';
                
            } catch (err) {
                setStatus('error', 'Microphone access denied');
                statusPill.style.display = 'inline-block';
                console.error('Error accessing microphone:', err);
            }
        });

        // Stop recording and send audio
        stopAudioBtn.addEventListener('click', async () => {
            if (!mediaRecorder || mediaRecorder.state === 'inactive') {
                return;
            }
            
            // Calculate duration
            const recordingDuration = Math.round((Date.now() - mediaRecorder.recordingStartTime) / 1000);
            
            // Stop recording
            mediaRecorder.stop();
            
            // Stop all tracks to release the microphone
            mediaRecorder.stream.getTracks().forEach(track => track.stop());
            
            mediaRecorder.addEventListener('stop', async () => {
                // Get the mimetype that was actually used
                const actualMimeType = mediaRecorder.mimeType || 'audio/webm';
                
                // Create audio blob from chunks
                const audioBlob = new Blob(audioChunks, { type: actualMimeType });
                
                // Convert to base64
                const reader = new FileReader();
                reader.readAsDataURL(audioBlob);
                
                reader.onloadend = async () => {
                    const base64Audio = reader.result.split(',')[1]; // Remove data:audio/...;base64, prefix
                    
                    // Prepare payload matching WhatsApp client format
                    const payload = {
                        from: senderEl.value,
                        message: null,  // Audio messages have null message body
                        messageType: 'ptt',  // 'ptt' for voice note (push-to-talk)
                        audio: {
                            mimetype: actualMimeType,
                            filename: null,
                            data: base64Audio,
                            filesize: audioBlob.size,
                            duration: recordingDuration,
                            isVoiceNote: true
                        }
                    };
                    
                    // UI loading state
                    setStatus('loading', 'Sending Audio');
                    responseBox.style.display = 'block';
                    previewToggle.style.display = 'inline-flex';
                    responseContent.textContent = '';
                    waBubble.textContent = '‚Äî';
                    copyBtn.style.display = 'none';
                    
                    // Show current view
                    if (currentView === 'actual') {
                        actualView.style.display = 'block';
                        formattedView.style.display = 'none';
                    } else {
                        actualView.style.display = 'none';
                        formattedView.style.display = 'block';
                    }
                    
                    const start = performance.now();
                    try {
                        const res = await fetch('/process', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(payload)
                        });
                        
                        const ok = res.ok;
                        let text = '';
                        let formattedText = '';
                        try {
                            const data = await res.clone().json();
                            text = JSON.stringify(data, null, 2);
                            formattedText = (data && (data.message || data.text || data.response)) || text;
                        } catch {
                            text = await res.text();
                            formattedText = text;
                        }
                        
                        const ms = Math.max(1, Math.round(performance.now() - start));
                        metaStatus.textContent = 'Status: ' + res.status + (ok ? ' OK' : ' ERROR');
                        metaTime.textContent = 'Time: ' + ms + ' ms';
                        metaSize.textContent = 'Size: ' + (text || '').length + ' chars';
                        
                        responseContent.textContent = text || '(empty response)';
                        waBubble.innerHTML = toWhatsAppPreview(formattedText);
                        setStatus(ok ? 'success' : 'error', ok ? 'Success' : 'Error');
                        copyBtn.style.display = 'inline-block';
                    } catch (err) {
                        const ms = Math.max(1, Math.round(performance.now() - start));
                        metaStatus.textContent = 'Status: NETWORK ERROR';
                        metaTime.textContent = 'Time: ' + ms + ' ms';
                        metaSize.textContent = 'Size: 0 chars';
                        responseContent.textContent = 'Network error: ' + (err && err.message ? err.message : 'Unknown');
                        setStatus('error', 'Network Error');
                    } finally {
                        // Reset UI
                        testAudioBtn.style.display = 'block';
                        stopAudioBtn.style.display = 'none';
                    }
                };
            });
        });

        
    </script>
</body>
</html>