name: Deploy Plugin

on:
  push:
    branches:
      - main
    paths:
      - 'plugin/**'
      - '.github/workflows/deploy.yml'
  workflow_dispatch:

concurrency:
  group: deploy-production
  cancel-in-progress: true

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Deploy plugin and restart gateway
        uses: appleboy/ssh-action@v1
        env:
          LOGLIFE_API_KEY: ${{ secrets.LOGLIFE_API_KEY }}
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          envs: LOGLIFE_API_KEY
          script: |
            set -e

            export PATH="$HOME/.local/bin:$HOME/openclaw/node_modules/.bin:$HOME/.nvm/versions/node/$(ls $HOME/.nvm/versions/node 2>/dev/null | tail -1)/bin:/usr/local/bin:$PATH"

            cd ~/loglife
            git fetch origin
            git checkout main
            git reset --hard origin/main

            # Resolve the openclaw binary
            if command -v openclaw &>/dev/null; then
              OPENCLAW=openclaw
            elif [ -x "$HOME/openclaw/openclaw.mjs" ]; then
              OPENCLAW="$HOME/openclaw/openclaw.mjs"
            else
              echo "ERROR: openclaw not found. Check installation."
              exit 1
            fi

            # Restart the gateway so it loads the updated plugin code
            $OPENCLAW gateway restart

            # Wait for gateway to come back up (plugin loading can take 10-15s)
            for i in 1 2 3 4 5 6; do
              sleep 5
              if curl -sf -o /dev/null "http://localhost:18789" 2>/dev/null; then
                echo "Gateway is up after ~$((i * 5))s"
                break
              fi
              echo "Waiting for gateway... ($((i * 5))s)"
            done

            # Health check: verify the LogLife plugin is loaded and responding
            SESSIONS_STATUS=$(curl -s -o /dev/null -w "%{http_code}" \
              -H "Authorization: Bearer $LOGLIFE_API_KEY" \
              "http://localhost:18789/loglife/sessions?phone=healthcheck" 2>/dev/null)

            VERIFY_STATUS=$(curl -s -o /dev/null -w "%{http_code}" \
              -X POST -H "Authorization: Bearer $LOGLIFE_API_KEY" \
              -H "Content-Type: application/json" \
              -d '{"phone":"0","code":"000000"}' \
              "http://localhost:18789/loglife/verify/check" 2>/dev/null)

            echo "Plugin health check: sessions=$SESSIONS_STATUS verify=$VERIFY_STATUS"

            # 404 = plugin loaded, searched, found nothing (expected)
            # 200 = plugin loaded, returned data (also fine)
            if [ "$SESSIONS_STATUS" != "404" ] && [ "$SESSIONS_STATUS" != "200" ]; then
              echo "ERROR: Sessions endpoint returned unexpected status $SESSIONS_STATUS"
              exit 1
            fi

            # 200 = plugin loaded, returned {verified:false} (expected)
            if [ "$VERIFY_STATUS" != "200" ]; then
              echo "ERROR: Verify endpoint returned unexpected status $VERIFY_STATUS"
              exit 1
            fi

            echo "All health checks passed."
